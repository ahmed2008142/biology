<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مراجعة التكاثر: اللاجنسي والجنسي</title>
    <!-- تحميل Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* تعيين خط عربي جميل للرؤية الأفضل */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900;600&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f8f9fa;
        }
        .quiz-option:hover {
            cursor: pointer;
            background-color: #e2e8f0;
            transition: background-color 0.2s;
        }
        .correct { background-color: #38a169; color: white; font-weight: bold; }
        .incorrect { background-color: #e53e3e; color: white; font-weight: bold; }
        .container-content { max-width: 900px; }
        .concept-box {
            background-color: #eef2ff;
            border-right: 6px solid #4f46e5;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .concept-box-green {
            background-color: #ecfdf5;
            border-right: 6px solid #10b981;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .exam-note {
            background-color: #fee2e2;
            border-left: 5px solid #ef4444;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-size: 1rem;
            font-weight: 700;
            color: #b91c1c;
        }
        .certificate {
            background: linear-gradient(135deg, #ffffff, #f0f4ff);
            border: 10px solid #a78bfa;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
            max-width: 600px;
            margin: 40px auto;
        }
        .cert-name {
            font-size: 2.2rem;
            font-weight: 800;
            color: #059669;
            border-bottom: 3px solid #10b981;
            padding-bottom: 5px;
            display: inline-block;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        .table-header th {
            padding: 0.75rem 1rem;
            text-align: right;
            background-color: #4f46e5;
            color: white;
            font-weight: 700;
        }
        .table-body td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.95rem;
        }
        .error-row {
            background-color: #fef2f2;
            color: #ef4444;
            font-weight: bold;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="container-content mx-auto bg-white shadow-2xl rounded-xl overflow-hidden">
        
        <!-- رأس الصفحة (Header) -->
        <header class="bg-indigo-700 text-white p-6 md:p-8">
            <h1 class="text-3xl md:text-4xl font-bold mb-1 border-b-2 border-indigo-400 pb-2">فصل التكاثر: شرح مفصل وكويز</h1>
            <p class="text-lg md:text-xl font-light">مراجعة شاملة مع نظام تتبع للنتائج في الوقت الفعلي</p>
        </header>

        <main class="p-6 md:p-10 space-y-10">

            <!-- ************************************ -->
            <!-- 1. نموذج إدخال البيانات -->
            <!-- ************************************ -->
            <section id="data-form-section" class="p-6 bg-yellow-50 rounded-lg shadow-xl">
                <h2 class="text-2xl font-bold text-yellow-800 border-r-4 border-yellow-600 pr-3 mb-6">قبل البدء: تحضير شهادة التقدير وتسجيل النتيجة</h2>
                
                <p class="text-gray-700 mb-4 font-semibold">
                    الرجاء إدخال اسمك ورقم هاتفك. هذه البيانات ستُحفظ مع نتيجتك (في قاعدة البيانات) لتتمكن من رؤية إنجازك.
                </p>
                
                <form id="user-data-form" class="mt-6 space-y-4">
                    <div>
                        <label for="full-name" class="block text-sm font-medium text-gray-700">الاسم الثلاثي:</label>
                        <input type="text" id="full-name" name="full-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="مثال: محمد أحمد علي">
                    </div>
                    <div>
                        <label for="phone-number" class="block text-sm font-medium text-gray-700">رقم الهاتف (للتواصل في الشهادة):</label>
                        <input type="tel" id="phone-number" name="phone-number" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="01XXXXXXXXX">
                    </div>
                    <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 rounded-lg shadow-md transition duration-300">
                        حفظ البيانات وبدء المراجعة
                    </button>
                    <p id="auth-status" class="text-center text-sm mt-2 text-gray-500">جاري الاتصال بقاعدة البيانات...</p>
                </form>
            </section>
            
            <!-- ************************************ -->
            <!-- محتوى المراجعة المفصلة (يظهر بعد إدخال البيانات) -->
            <!-- ************************************ -->
            <div id="review-content" class="hidden">
                
                <section>
                    <h2 class="text-2xl font-bold text-indigo-800 border-r-4 border-indigo-600 pr-3 mb-6">1. صور التكاثر اللاجنسي (شرح كامل للامتحان)</h2>
                    
                    <!-- الانشطار الثنائي -->
                    <div class="concept-box">
                        <h3 class="text-xl font-bold text-indigo-700">أ) الانشطار الثنائي (Binary Fission)</h3>
                        <p class="text-gray-700 mt-2">
                            **المفهوم:** تنقسم الخلية الأم إلى خليتين متماثلتين في الحجم والصفات الوراثية (بالانقسام الميتوزي).
                        </p>
                        <ul class="list-disc list-inside mt-2 text-gray-600 space-y-1 pr-4">
                            <li>**مثال:** الأميبا، البراميسيوم، البكتيريا، والطحالب البسيطة.</li>
                            <li>**ملاحظة هامة:** الفرد الأبوي يختفي تماماً (لا يتبقى منه أثر) ويتحول إلى فردين جديدين.</li>
                            <li>**الظروف الصعبة (الأميبا):** تتحوصل الأميبا وتنقسم عدة مرات بالانشطار المتعدد، ثم تتحرر الأفراد الجديدة (تكاثر لاجنسي).</li>
                        </ul>
                    </div>
                    [Image of التكاثر اللاجنسي بالانشطار الثنائي]

                    <!-- التبرعم -->
                    <div class="concept-box-green">
                        <h3 class="text-xl font-bold text-green-700">ب) التبرعم (Budding)</h3>
                        <p class="text-gray-700 mt-2">
                            **المفهوم:** ينشأ برعم صغير (نتوء) من الخلية الأم، ينمو وينفصل أو يبقى متصلاً لتكوين مستعمرة.
                        </p>
                        <ul class="list-disc list-inside mt-2 text-gray-600 space-y-1 pr-4">
                            <li>**فطر الخميرة (أحادي الخلية):** الانقسام غير متساوٍ في حجم السيتوبلازم، لكنه متساوٍ في المادة الوراثية (ميتوزي).</li>
                            <li>**الهيدرا والإسفنج (عديد الخلايا):** البرعم ينشأ من مجموعة خلايا بينية. قد ينفصل أو يبقى متصلاً.</li>
                        </ul>
                    </div>
                    

                    <!-- التكاثر بالجراثيم -->
                    <div class="concept-box">
                        <h3 class="text-xl font-bold text-indigo-700">ج) التكاثر بالجراثيم (Spore Reproduction)</h3>
                        <p class="text-gray-700 mt-2">
                            **المفهوم:** تنتج الكائنات أعداداً هائلة من الجراثيم (ن)، وكل جرثومة تنمو إلى فرد جديد (بالميتوزي).
                        </p>
                        <ul class="list-disc list-inside mt-2 text-gray-600 space-y-1 pr-4">
                            <li>**أمثلة:** الفطريات (عفن الخبز) والطحالب والنباتات (نبات الفوجير).</li>
                            <li>**الميزة الأهم:** أسرع وأكثر انتشاراً (خفيفة الوزن، صلبة الغلاف، تتحمل الجفاف).</li>
                        </ul>
                    </div>
                    
                    
                    <!-- التجدد -->
                    <div class="concept-box-green">
                        <h3 class="text-xl font-bold text-green-700">د) التجدد (Regeneration)</h3>
                        <ul class="list-disc list-inside mt-2 text-gray-600 space-y-1 pr-4">
                            <li>**التجدد كوسيلة للتكاثر:** في الكائنات الأقل تطوراً (مثل نجم البحر والبلاناريا).
                                <ul class="list-circle list-inside mt-1 text-gray-600 space-y-1 pr-4">
                                    <li>**البلاناريا:** إذا قُطعت رأسياً أو أفقياً، كل قطعة تنمو إلى دودة كاملة (تتطلب خلايا انقسامية).</li>
                                    <li>**نجم البحر:** إذا قُطعت ذراع مع جزء من القرص الوسطي، تنمو لذات كامل (تتكاثر).</li>
                                </ul>
                            </li>
                            <li>**التجدد كوسيلة لتعويض الأجزاء المفقودة:** في الكائنات الأكثر تطوراً (الإنسان، السلمندر).
                                <ul class="list-circle list-inside mt-1 text-gray-600 space-y-1 pr-4">
                                    <li>**الإنسان:** يقتصر على التئام الجروح وتجديد خلايا الكبد التالفة.</li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                    
                    
                    <!-- التوالد البكري -->
                    <div class="concept-box">
                        <h3 class="text-xl font-bold text-indigo-700">هـ) التوالد البكري (Parthenogenesis)</h3>
                        <p class="text-gray-700 mt-2">
                            **المفهوم:** قدرة البويضة على النمو وتكوين فرد كامل دون إخصاب من حيوان منوي.
                        </p>
                        <ul class="list-disc list-inside mt-2 text-gray-600 space-y-1 pr-4">
                            <li>**نحل العسل (طبيعي):** البويضة (ن) ← تنمو بالميتوزي ← ذكور (ن).</li>
                            <li>**حشرة المن (طبيعي):** البويضة (2ن) ← تنمو بالميتوزي ← إناث (2ن).</li>
                            <li>**الضفادع والأرانب (صناعي):** تحفيز البويضة كهربياً أو كيميائياً (ينتج إناث فقط 2ن).</li>
                        </ul>
                    </div>
                    
                    <!-- زراعة الأنسجة -->
                    <div class="concept-box-green">
                        <h3 class="text-xl font-bold text-green-700">و) زراعة الأنسجة (Tissue Culture)</h3>
                        <p class="text-gray-700 mt-2">
                            **المفهوم:** فصل جزء نباتي صغير وزرعه في وسط غذائي مناسب يحتوي على هرمونات (تطبيق لظاهرة **الخلية الكاملة القدرة**).
                        </p>
                        <ul class="list-disc list-inside mt-2 text-gray-600 space-y-1 pr-4">
                            <li>**الأهمية:** إنتاج أعداد كبيرة من نباتات متطابقة وراثياً في وقت قصير، وحل مشاكل المواسم.</li>
                        </ul>
                    </div>
                    

                </section>
                
                <section class="mt-10 p-6 bg-blue-50 rounded-lg shadow-xl">
                    <h2 class="text-2xl font-bold text-blue-800 border-r-4 border-blue-600 pr-3 mb-6">2. دورة حياة الفوجير (تعاقب الأجيال المفصل)</h2>
                    <div class="p-4 bg-white rounded-lg border border-blue-200">
                        
                        <h3 class="text-xl font-bold text-blue-700 mb-2">الجيل الأول: الطور الجرثومي (2ن) - السائد</h3>
                        <p class="text-gray-700 leading-relaxed pl-4">
                            1.  **الصفات:** الطور السائد، كبير الحجم، يحمل الجراثيم، يعيش معتمداً على نفسه.
                            2.  **التكاثر:** **لاجنسي**. يحمل بثرات (حافظات جرثومية) على السطح السفلي للأوراق.
                            3.  **الناتج:** تنقسم الخلايا الأم للجراثيم (2ن) **انقساماً ميوزياً** لتنتج الجراثيم (ن).
                        </p>
                        
                        <hr class="my-4 border-blue-100">

                        <h3 class="text-xl font-bold text-blue-700 mb-2">الجيل الثاني: الطور المشيجي (ن) - المؤقت</h3>
                        <p class="text-gray-700 leading-relaxed pl-4">
                            1.  **النشأة:** تسقط الجرثومة (ن) في تربة رطبة ← تنمو **بالميتوزي** ← لتكون الطور المشيجي (ن) على شكل جسم قلبي.
                            2.  **التكاثر:** **جنسي**. يحمل الأعضاء المذكرة (الأرشونيا) والمؤنثة (الأنثريديا).
                            3.  **الإخصاب:** يتطلب **وجود الماء** لتنتقل السابحات المهدبة إلى البويضة.
                            4.  **الناتج:** ينتج الزيجوت (2ن) الذي ينمو إلى طور جرثومي جديد (تبدأ دورة جديدة).
                        </p>
                        

                        <div class="exam-note" style="border-left: 5px solid #059669; color: #065f46; background-color: #d1fae5;">
                            **خلاصة الامتحانات:** تعاقب الأجيال يضمن **التنوع الوراثي** (الجنسي) و**وفرة النسل** وسرعة انتشاره (اللاجنسي). الانقسام الميوزي يحدث فقط في الطور الجرثومي لإنتاج الجراثيم.
                        </div>
                    </div>
                </section>


                <!-- ************************************ -->
                <!-- ثالثاً: الكويز التفاعلي (15 سؤالاً) -->
                <!-- ************************************ -->
                <section id="quiz" class="p-6 bg-gray-100 rounded-lg shadow-xl mt-10">
                    <h2 class="text-2xl font-bold text-gray-800 border-r-4 border-gray-600 pr-3 mb-6">3. كويز تفاعلي (15 سؤالاً شاملاً)</h2>
                    
                    <div id="questions-container" class="space-y-6">
                        <!-- سيتم ملء الأسئلة بواسطة JavaScript -->
                    </div>

                    <button id="submit-quiz" class="mt-8 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-md transition duration-300">
                        إنهاء الكويز وحفظ النتيجة
                    </button>

                    <div id="results" class="mt-6 p-4 bg-white rounded-lg border border-gray-300 hidden">
                        <h3 class="text-xl font-bold text-indigo-700 mb-2">نتيجة الاختبار:</h3>
                        <p id="score-text" class="text-2xl font-extrabold"></p>
                        <p id="review-message" class="mt-2 text-gray-600"></p>
                    </div>
                </section>
            </div>
            
            <!-- ************************************ -->
            <!-- رابعاً: شهادة التقدير (تظهر عند النجاح) -->
            <!-- ************************************ -->
            <section id="certificate-section" class="hidden">
                <div class="certificate">
                    <div class="cert-header">شهادة تقدير</div>
                    <div class="cert-body">
                        <p>تُمنح هذه الشهادة المتميزة للطالب/الطالبة الذي أظهر اجتهاداً وتفوقاً في إتقان تفاصيل فصل التكاثر وحصل على نسبة نجاح لا تقل عن 90%.</p>
                    </div>
                    <p class="text-xl font-semibold text-gray-700">تُمنح إلى:</p>
                    <div id="cert-name-display" class="cert-name"></div>
                    <div class="cert-date">تاريخ الإصدار: <span id="current-date"></span></div>
                    <p class="text-sm text-gray-500 mt-4">مع تمنياتنا بدوام التوفيق والنجاح</p>
                </div>
            </section>

            <!-- ************************************ -->
            <!-- خامساً: قسم التحقق من كلمة المرور (جديد) -->
            <!-- ************************************ -->
            <section class="mt-12 p-6 bg-gray-200 rounded-lg shadow-xl">
                <h2 class="text-2xl font-bold text-gray-800 border-r-4 border-gray-600 pr-3 mb-6">5. الوصول إلى نتائج الطلاب (إداري)</h2>
                
                <div id="password-gate">
                    <p class="text-gray-700 mb-4">
                        هذا القسم محمي بكلمة مرور. يرجى إدخال الكلمة الإدارية للمتابعة ورؤية النتائج المباشرة.
                    </p>
                    <form id="admin-password-form" class="flex space-x-2 rtl:space-x-reverse">
                        <input type="password" id="admin-password" placeholder="كلمة المرور الإدارية" required class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-2 border">
                        <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                            فتح النتائج
                        </button>
                    </form>
                    <p id="password-message" class="text-sm mt-2 text-red-500 hidden font-bold">كلمة المرور غير صحيحة. حاول مجدداً.</p>
                </div>

                <!-- جدول النتائج المباشر (مخفي مبدئياً) -->
                <div id="results-table-container" class="mt-6 hidden">
                    <h3 class="text-xl font-bold text-red-800 border-r-4 border-red-600 pr-3 mb-4">جدول نتائج المراجعين المباشر (Real-time)</h3>
                    <div class="overflow-x-auto rounded-lg shadow">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="table-header">
                                <tr>
                                    <th scope="col" class="rounded-tr-lg">الاسم</th>
                                    <th scope="col">رقم الهاتف</th>
                                    <th scope="col">الدرجة</th>
                                    <th scope="col" class="rounded-tl-lg">التاريخ</th>
                                </tr>
                            </thead>
                            <tbody id="results-table-body" class="bg-white divide-y divide-gray-200 table-body">
                                <tr><td colspan="4" class="text-center py-4 text-gray-500">جاري تحميل النتائج...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

        </main>

        <!-- التذييل (Footer) -->
        <footer class="bg-indigo-700 text-white text-center p-4 text-sm">
            <p>&copy; 2024 مراجعة الأحياء (الفصل الثالث). كل الحقوق محفوظة.</p>
        </footer>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ******* تفعيل وضع التصحيح (ضروري جداً لتتبع أخطاء Firestore) *******
        setLogLevel('debug');
        
        // ******* متغيرات Firebase الموفرة من البيئة *******
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // ******* كلمة المرور الإدارية (يمكن تغييرها) *******
        const ADMIN_PASSWORD = '123456'; 

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let isListenerAttached = false; // flag لمنع تشغيل المستمع أكثر من مرة
        let isAdminLoggedIn = false; // ***** جديد: حالة تسجيل الدخول الإداري *****

        // متغيرات تخزين بيانات المستخدم بشكل مؤقت
        let userName = '';
        let userPhone = '';

        // عناصر التحكم في واجهة المستخدم
        const dataFormSection = document.getElementById('data-form-section');
        const reviewContent = document.getElementById('review-content');
        const userDataForm = document.getElementById('user-data-form');
        const certificateSection = document.getElementById('certificate-section');
        const certNameDisplay = document.getElementById('cert-name-display');
        const currentDateSpan = document.getElementById('current-date');
        const submitButton = document.getElementById('submit-quiz');
        const resultsDiv = document.getElementById('results');
        const scoreText = document.getElementById('score-text');
        const reviewMessage = document.getElementById('review-message');
        const authStatus = document.getElementById('auth-status');
        
        // عناصر قسم الحماية الجديد
        const adminPasswordForm = document.getElementById('admin-password-form');
        const resultsTableContainer = document.getElementById('results-table-container');
        const passwordMessage = document.getElementById('password-message');
        const resultsTableBody = document.getElementById('results-table-body');
        
        const QUIZ_COLLECTION = 'quiz_results';

        // تهيئة Firebase والتوثيق
        async function initFirebaseAndAuth() {
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                authStatus.textContent = 'خطأ: لم يتم تهيئة Firebase بشكل صحيح. تحقق من __firebase_config.';
                console.error("Firebase config is missing or invalid.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // استخدام onAuthStateChanged لضمان أن جميع العمليات تبدأ بعد التوثيق
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        authStatus.textContent = `تم الاتصال بنجاح. معرف المستخدم: ${userId.substring(0, 8)}...`;
                        console.log("Firebase Auth State Changed: User signed in with UID:", userId);
                        
                        // ***** الكود المحدث: تحقق مما إذا كان المدير قد سجل دخوله لتبدأ تحميل النتائج *****
                        if (isAdminLoggedIn) {
                            setupRealtimeResultsListener();
                        }
                        // ********************************************************************************

                    } else {
                        isAuthReady = true;
                        authStatus.textContent = 'تم تسجيل الدخول كمستخدم مجهول.';
                        console.log("Firebase Auth State Changed: User is anonymous/logged out.");
                        
                        // قد يكون المستخدم مجهولاً، ولكن المستمع يجب أن يبدأ إذا كان المدير قد طلب ذلك
                        if (isAdminLoggedIn) {
                            setupRealtimeResultsListener();
                        }
                    }
                });

                // محاولة تسجيل الدخول باستخدام الرمز المخصص أو كمجهول
                if (authToken) {
                    await signInWithCustomToken(auth, authToken);
                    console.log("Attempting sign in with custom token...");
                } else {
                    await signInAnonymously(auth);
                    console.log("Attempting anonymous sign in...");
                }

            } catch (error) {
                console.error("Firebase Auth or Init error:", error);
                authStatus.textContent = `فشل الاتصال: ${error.message}`;
            }
        }
        
        // دالة حفظ النتيجة في Firestore
        async function saveResultsToFirestore(score, totalQuestions) {
            if (!isAuthReady || !db) {
                console.error("Firestore not ready or user not authenticated. Cannot save results.");
                return;
            }

            // المسار العام للنتائج: /artifacts/{appId}/public/data/quiz_results
            const publicResultsPath = `artifacts/${appId}/public/data/${QUIZ_COLLECTION}`;
            
            try {
                const docRef = await addDoc(collection(db, publicResultsPath), {
                    // بيانات الطالب التي تم إدخالها قبل البدء
                    studentName: userName,
                    studentPhone: userPhone,
                    
                    // نتائج الكويز
                    score: score,
                    totalQuestions: totalQuestions,
                    percentage: (score / totalQuestions) * 100,
                    
                    // بيانات إدارية
                    appId: appId,
                    userId: userId || 'anonymous',
                    timestamp: serverTimestamp() // لتسجيل وقت الحفظ
                });
                console.log("Document successfully written to:", publicResultsPath, " with ID:", docRef.id);
            } catch (e) {
                console.error("Error adding document (Saving Failed). Check security rules and path:", publicResultsPath, e);
                // رسالة واجهة مستخدم إضافية تفيد بالفشل
                reviewMessage.textContent += " (فشل حفظ النتيجة في القاعدة - تحقق من الاتصال والأذونات)";
            }
        }
        
        // دالة إعداد مستمع النتائج في الوقت الفعلي
        function setupRealtimeResultsListener() {
            if (!isAuthReady || !db) {
                console.error("Firestore not ready. Cannot attach real-time listener. (isAuthReady:", isAuthReady, ", db:", !!db, ")");
                resultsTableBody.innerHTML = `<tr><td colspan="4" class="error-row text-center py-4">فشل الاتصال: قاعدة البيانات غير جاهزة أو التوثيق غير مكتمل.</td></tr>`;
                // ***** مهم: تم إيقاف الـ 'return' لمنع تكرار الرسالة عند أول محاولة *****
                return;
            }

            if (isListenerAttached) {
                console.warn("Listener is already attached. Skipping.");
                return;
            }
            
            const publicResultsPath = `artifacts/${appId}/public/data/${QUIZ_COLLECTION}`;
            console.log("Attaching real-time listener to path:", publicResultsPath);
            isListenerAttached = true; 

            const resultsQuery = query(collection(db, publicResultsPath));
            
            // ***** تحديث: إظهار رسالة تحميل صحيحة قبل بدء onSnapshot *****
            resultsTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">جاري تحميل النتائج...</td></tr>`;

            onSnapshot(resultsQuery, (snapshot) => {
                resultsTableBody.innerHTML = ''; // مسح الجدول القديم
                
                if (snapshot.empty) {
                    resultsTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">لم يتم تسجيل أي نتائج بعد.</td></tr>`;
                    console.log("Real-time results snapshot is empty.");
                    return;
                }

                const results = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    results.push(data);
                });
                
                // فرز النتائج تنازلياً حسب التاريخ
                results.sort((a, b) => {
                    const timeA = a.timestamp?.seconds || 0;
                    const timeB = b.timestamp?.seconds || 0;
                    return timeB - timeA;
                });

                results.forEach(result => {
                    const date = result.timestamp ? new Date(result.timestamp.seconds * 1000).toLocaleDateString('ar-EG', {
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : 'غير متوفر';
                    
                    const score = result.score || 0;
                    const totalQuestions = result.totalQuestions || 1;
                    const percentage = (result.percentage || 0).toFixed(0);
                    
                    const row = document.createElement('tr');
                    const scoreColor = percentage >= 90 ? 'text-green-600 font-bold' : (percentage >= 70 ? 'text-yellow-600' : 'text-red-600');
                    
                    row.innerHTML = `
                        <td class="whitespace-nowrap">${result.studentName}</td>
                        <td class="whitespace-nowrap">${result.studentPhone}</td>
                        <td class="whitespace-nowrap ${scoreColor}">${score} / ${totalQuestions} (${percentage}%)</td>
                        <td class="whitespace-nowrap">${date}</td>
                    `;
                    resultsTableBody.appendChild(row);
                });
            }, (error) => {
                // ******* معالجة خطأ المستمع وإظهاره بوضوح *******
                console.error("Error listening to real-time results (onSnapshot failed):", error);
                const errorMessage = `خطأ في تحميل النتائج: فشل المستمع. السبب المحتمل: مشكلة في الأذونات أو مسار البيانات. (رسالة الخطأ: ${error.message})`;
                resultsTableBody.innerHTML = `<tr><td colspan="4" class="error-row text-center py-4">${errorMessage}</td></tr>`;
                
                // إظهار رسالة للمستخدم
                passwordMessage.textContent = 'فشل في تحميل النتائج المباشرة. يرجى مراجعة Console لمعرفة تفاصيل الخطأ.';
                passwordMessage.classList.remove('hidden');
                passwordMessage.classList.add('text-red-700');
            });
        }
        
        // ******* منطق التحقق من كلمة المرور الإدارية *******
        adminPasswordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const inputPassword = document.getElementById('admin-password').value;

            if (inputPassword === ADMIN_PASSWORD) {
                // كلمة المرور صحيحة
                isAdminLoggedIn = true; // ***** تعيين حالة المدير *****
                resultsTableContainer.classList.remove('hidden');
                passwordMessage.classList.add('hidden');
                
                // تعطيل نموذج كلمة المرور بعد النجاح
                document.getElementById('password-gate').innerHTML = '<p class="text-lg font-bold text-green-700">تم فتح النتائج بنجاح.</p>';
                
                // ***** الكود المحدث: إذا كان التوثيق جاهزاً بالفعل، ابدأ التحميل الآن *****
                if (isAuthReady && db) {
                    setupRealtimeResultsListener();
                } else {
                    console.log("Authentication not yet ready. Waiting for onAuthStateChanged to trigger listener.");
                    resultsTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-yellow-600 font-bold">تم إدخال كلمة المرور. جاري انتظار اتصال قاعدة البيانات...</td></tr>`;
                }
                // ********************************************************************************

            } else {
                // كلمة المرور غير صحيحة
                passwordMessage.textContent = 'كلمة المرور غير صحيحة. حاول مجدداً.';
                passwordMessage.classList.remove('hidden');
                document.getElementById('admin-password').value = ''; // مسح الإدخال
            }
        });
        
        // ******* منطق واجهة المستخدم (UI Logic) *******
        
        // 1. وظيفة لإظهار محتوى المراجعة بعد إدخال البيانات
        userDataForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            // تخزين البيانات
            userName = document.getElementById('full-name').value;
            userPhone = document.getElementById('phone-number').value;

            // إخفاء نموذج الإدخال وإظهار محتوى المراجعة
            dataFormSection.classList.add('hidden');
            reviewContent.classList.remove('hidden');

            // التمرير إلى بداية المحتوى
            reviewContent.scrollIntoView({ behavior: 'smooth' });

            // تعيين التاريخ الحالي للشهادة
            currentDateSpan.textContent = new Date().toLocaleDateString('ar-EG', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        });


        // بيانات وأسئلة الكويز (كما هي)
        const questions = [
            { question: "أي الكائنات التالية هو الوحيد الذي يختفي فيه الفرد الأبوي بعد التكاثر؟", options: ["الهيدرا", "نجم البحر", "فطر الخميرة", "الأميبا"], answer: "الأميبا" },
            { question: "ما نوع الانقسام الذي يحدث عند نمو الجرثومة (ن) لتعطي كائناً كاملاً؟", options: ["انقسام ميوزي", "انشطار ثنائي", "انقسام ميتوزي", "إخصاب"], answer: "انقسام ميتوزي" },
            { question: "ماذا ينتج عن التوالد البكري في نحل العسل؟", options: ["ذكور (ن)", "إناث (2ن)", "إناث (ن)", "ذكور (2ن)"], answer: "ذكور (ن)" },
            { question: "إذا قطعت ذراع نجم البحر دون أن تحتوي على جزء من القرص الوسطي، ماذا يحدث؟", options: ["تنمو الذراع إلى فرد جديد", "يتعوض الجزء المفقود من الذراع فقط", "يموت نجم البحر", "يتكاثر بالتوالد البكري"], answer: "يتعوض الجزء المفقود من الذراع فقط" },
            { question: "الطور الجرثومي (2ن) لنبات الفوجير ينتج الجراثيم (ن) عن طريق انقسام:", options: ["ميتوزي", "ميوزي", "تبرعم", "انشطار ثنائي"], answer: "ميوزي" },
            { question: "ما هي الميزة الوراثية الأساسية للتكاثر الجنسي؟", options: ["سرعة الإنجاب", "المحافظة على ثبات الصفات", "زيادة التنوع الوراثي", "إنتاج عدد محدود من الأفراد"], answer: "زيادة التنوع الوراثي" },
            { question: "في فطر الخميرة، يتميز الانقسام عند التبرعم بأنه:", options: ["متساوٍ في حجم السيتوبلازم", "ينتج خلايا متطابقة في الحجم", "غير متساوٍ في حجم السيتوبلازم", "يختفي فيه الأب"], answer: "غير متساوٍ في حجم السيتوبلازم" },
            { question: "عندما تتكاثر حشرة المن لاجنسياً بالتوالد البكري، فإنها تنتج:", options: ["ذكور (ن)", "إناث (2ن)", "إناث (ن)", "ذكور (2ن)"], answer: "إناث (2ن)" },
            { question: "الكائن الذي يلجأ للتكاثر الجنسي (بالاقتران) في الظروف غير المناسبة هو:", options: ["البراميسيوم", "طحلب الإسبيروجيرا", "الأميبا", "فطر عفن الخبز"], answer: "طحلب الإسبيروجيرا" },
            { question: "في ظروف الجفاف، تلجأ الأميبا لـ:", options: ["التبرعم", "التكاثر بالجراثيم", "الانشطار المتعدد داخل الحوصلة", "التجدد"], answer: "الانشطار المتعدد داخل الحوصلة" },
            { question: "أي من طرق التكاثر اللاجنسي هي الأفضل للانتشار لمسافات بعيدة؟", options: ["التوالد البكري", "التبرعم", "التكاثر بالجراثيم", "التجدد"], answer: "التكاثر بالجراثيم" },
            { question: "التئام الجروح في الإنسان يصنف ضمن التجدد لـ:", options: ["التكاثر", "التعويض", "الحماية", "النمو"], answer: "التعويض" },
            { question: "ما هي المجموعة الصبغية لخلايا الطور المشيجي لنبات الفوجير؟", options: ["2ن", "4ن", "ن", "3ن"], answer: "ن" },
            { question: "الظاهرة التي تجمع بين التكاثر الجنسي واللاجنسي في دورة حياة واحدة هي:", options: ["التوالد البكري", "الاقتران", "تعاقب الأجيال", "الانشطار الثنائي"], answer: "تعاقب الأجيال" },
            { question: "تنقسم خلايا البلاناريا لتعويض الأجزاء المفقودة باستخدام انقسام:", options: ["ميوزي", "ميتوزي", "انشطار ثنائي", "اختزالي"], answer: "ميتوزي" }
        ];
        
        const questionsContainer = document.getElementById('questions-container');
        let selectedAnswers = {};

        // 2. عرض الأسئلة
        function displayQuestions() {
            questions.forEach((q, index) => {
                const qElement = document.createElement('div');
                qElement.className = 'p-4 bg-white rounded-lg shadow';
                qElement.innerHTML = `
                    <p class="font-semibold text-lg text-gray-900 mb-3">السؤال ${index + 1}: ${q.question}</p>
                    <div class="options space-y-2" data-index="${index}">
                        ${q.options.map(option => `
                            <div class="quiz-option p-3 border border-gray-200 rounded-md text-gray-700" data-option="${option}">
                                ${option}
                            </div>
                        `).join('')}
                    </div>
                `;
                questionsContainer.appendChild(qElement);
            });
            // يجب إخفاء محتوى المراجعة عند التحميل الأولي
            reviewContent.classList.add('hidden');
        }

        // 3. معالجة اختيار الإجابات
        questionsContainer.addEventListener('click', (e) => {
            const optionDiv = e.target.closest('.quiz-option');
            if (!optionDiv || resultsDiv.classList.contains('active')) return;

            const optionsContainer = optionDiv.closest('.options');
            const questionIndex = optionsContainer.getAttribute('data-index');
            const selectedOption = optionDiv.getAttribute('data-option');

            optionsContainer.querySelectorAll('.quiz-option').forEach(opt => {
                opt.classList.remove('bg-indigo-300', 'border-indigo-600');
            });

            optionDiv.classList.add('bg-indigo-300', 'border-indigo-600');
            selectedAnswers[questionIndex] = selectedOption;
        });

        // 4. إنهاء الكويز وعرض النتيجة وحفظها
        submitButton.addEventListener('click', () => {
            if (resultsDiv.classList.contains('active')) return;

            // التأكد من إدخال البيانات قبل محاولة حفظ النتيجة
            if (!userName || !userPhone) {
                // استخدام مربع رسالة مخصص بدلاً من alert()
                const messageBox = document.createElement('div');
                messageBox.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                messageBox.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-2xl text-center max-w-sm">
                        <p class="text-lg font-bold text-red-600 mb-4">خطأ في البيانات</p>
                        <p class="text-gray-700 mb-6">الرجاء إدخال اسمك ورقم هاتفك في القسم العلوي قبل إنهاء الكويز.</p>
                        <button id="close-message" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition duration-300">حسناً</button>
                    </div>
                `;
                document.body.appendChild(messageBox);

                document.getElementById('close-message').addEventListener('click', () => {
                    messageBox.remove();
                    dataFormSection.scrollIntoView({ behavior: 'smooth' });
                });
                return; 
            }

            let score = 0;
            const totalQuestions = questions.length;
            const requiredScore = totalQuestions * 0.9; // 90% للحصول على شهادة (14 سؤال صحيح على الأقل)

            questions.forEach((q, index) => {
                const isCorrect = selectedAnswers[index] === q.answer;
                if (isCorrect) {
                    score++;
                }

                const optionsContainer = document.querySelector(`.options[data-index="${index}"]`);
                if (optionsContainer) {
                    optionsContainer.querySelectorAll('.quiz-option').forEach(opt => {
                        opt.classList.remove('bg-indigo-300', 'border-indigo-600');
                        opt.style.pointerEvents = 'none'; 

                        const optionValue = opt.getAttribute('data-option');
                        if (optionValue === q.answer) {
                            opt.classList.add('correct');
                        } else if (optionValue === selectedAnswers[index]) {
                            opt.classList.add('incorrect');
                        }
                    });
                }
            });
            
            // ******* الحفظ في قاعدة البيانات هنا *******
            saveResultsToFirestore(score, totalQuestions);

            // عرض النتائج
            const percentage = (score / totalQuestions) * 100;
            scoreText.textContent = `${score} من ${totalQuestions} (${percentage.toFixed(0)}%)`;

            if (score >= requiredScore) {
                reviewMessage.textContent = 'أداء ممتاز جداً! تفوق في المراجعة. تفضل شهادة التقدير.';
                scoreText.classList.remove('text-red-600', 'text-yellow-600');
                scoreText.classList.add('text-green-600');
                certNameDisplay.textContent = userName;
                certificateSection.classList.remove('hidden');
            } else {
                reviewMessage.textContent = 'تحتاج إلى مراجعة إضافية. عد إلى الشرح وتعمق في المفاهيم الأساسية.';
                scoreText.classList.remove('text-yellow-600', 'text-green-600');
                scoreText.classList.add('text-red-600');
                certificateSection.classList.add('hidden');
            }


            resultsDiv.classList.remove('hidden');
            resultsDiv.classList.add('active'); // وضع علامة أن الكويز انتهى
            submitButton.disabled = true;
            submitButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            submitButton.classList.add('bg-gray-400', 'cursor-not-allowed');

            // نقل المستخدم للنتيجة
            document.getElementById('quiz').scrollIntoView({ behavior: 'smooth' });
        });

        // تشغيل التهيئة والأسئلة عند تحميل الصفحة
        window.onload = () => {
            initFirebaseAndAuth();
            displayQuestions();
        };
    </script>
</body>
</html>
